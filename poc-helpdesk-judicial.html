<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sojus | Sistema de Gestión Judicial</title>
    <!-- Fonts: Lexend (headings) + Source Sans 3 (body) + JetBrains Mono (code/ids) — UI/UX Pro Max: Corporate Trust -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&family=Source+Sans+3:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <!-- Icons: Material Symbols Outlined -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            /* Palette — UI/UX Pro Max: Government/Public Service */
            --primary: #0a1628;
            --primary-light: #162236;
            --primary-mid: #1c2d45;
            --accent: #0369A1;
            --accent-light: #0284C7;
            --accent-glow: rgba(3, 105, 161, 0.15);
            --bg-body: #F8FAFC;
            --bg-card: #ffffff;
            --text-main: #020617;
            --text-muted: #475569;
            --border: #dfe3ea;
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
            --card-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.08);

            /* Semantics */
            --success: #059669;
            --success-bg: rgba(5, 150, 105, 0.08);
            --warning: #d97706;
            --warning-bg: rgba(217, 119, 6, 0.08);
            --danger: #dc2626;
            --danger-bg: rgba(220, 38, 38, 0.08);
            --info: #2563eb;
            --info-bg: rgba(37, 99, 235, 0.08);

            /* Spacing */
            --header-height: 60px;
            --sidebar-width: 270px;
            --radius: 10px;
            --radius-lg: 14px;

            /* Typography — UI/UX Pro Max: Corporate Trust */
            --font-heading: 'Lexend', sans-serif;
            --font-body: 'Source Sans 3', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        /* ===== DARK MODE ===== */
        [data-theme="dark"] {
            --primary: #020817;
            --primary-light: #0c1524;
            --primary-mid: #131f33;
            --bg-body: #0c1524;
            --bg-card: #162236;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #1e3050;
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --card-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-body);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }

        /* === UTILS === */
        .mono {
            font-family: var(--font-mono);
        }

        .text-sm {
            font-size: 0.85rem;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .text-lg {
            font-size: 1.15rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .uppercase {
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .p-4 {
            padding: 1rem;
        }

        .px-6 {
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        .hidden {
            display: none !important;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #0F172A 0%, #0d1b30 50%, #0F172A 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-right: 1px solid rgba(255, 255, 255, 0.04);
            position: relative;
        }

        .sidebar::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(180deg, transparent, rgba(3, 105, 161, 0.3), transparent);
        }

        .brand {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 1.25rem;
            gap: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            position: relative;
        }

        .brand-shield {
            width: 36px;
            height: 36px;
            object-fit: contain;
            filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.4));
            flex-shrink: 0;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
            line-height: 1.15;
        }

        .brand-text .brand-name {
            font-size: 1.15rem;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: #fff;
            font-family: var(--font-heading);
        }

        .brand-text .brand-sub {
            font-size: 0.6rem;
            color: rgba(56, 189, 248, 0.8);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 500;
        }

        .nav-menu {
            flex: 1;
            padding: 0.75rem 0;
            overflow-y: auto;
        }

        .nav-section-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: rgba(255, 255, 255, 0.25);
            padding: 1rem 1.25rem 0.4rem;
            font-weight: 600;
        }

        .nav-item {
            padding: 0.65rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: rgba(255, 255, 255, 0.45);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            font-size: 0.9rem;
            font-weight: 400;
            margin: 1px 0;
            position: relative;
        }

        .nav-item:hover {
            color: rgba(255, 255, 255, 0.85);
            background: rgba(255, 255, 255, 0.03);
            border-left-color: rgba(3, 105, 161, 0.4);
        }

        .nav-item.active {
            color: #fff;
            background: linear-gradient(90deg, rgba(3, 105, 161, 0.15), transparent);
            border-left-color: var(--accent);
            font-weight: 500;
        }

        .nav-item .material-symbols-outlined {
            font-size: 1.2rem;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ===== HEADER ===== */
        .app-header {
            height: var(--header-height);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
        }

        .app-header h2 {
            font-size: 1.05rem;
            font-weight: 600;
            font-family: var(--font-heading);
        }

        .omnisearch {
            background: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.45rem 1rem;
            width: 380px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .omnisearch:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .omnisearch input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
            color: var(--text-main);
            font-size: 0.85rem;
        }

        .icon-btn {
            background: none;
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 0.4rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--bg-body);
            border-color: var(--border);
            color: var(--text-main);
        }

        /* ===== VIEWS ===== */
        .view-container {
            padding: 1.5rem 2rem;
            overflow-y: auto;
            flex: 1;
        }

        /* ===== STAT CARDS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.25rem 1.5rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            box-shadow: var(--card-shadow);
            transition: box-shadow 0.25s ease, transform 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #0369A1, #0EA5E9);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-2px);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            font-family: var(--font-heading);
            background: linear-gradient(135deg, #0F172A 0%, #334155 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        [data-theme="dark"] .stat-value {
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }

        /* ===== TABLES ===== */
        .data-table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 0.7rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--bg-body);
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr {
            transition: background 0.15s ease;
        }

        tbody tr:hover {
            background: rgba(3, 105, 161, 0.04);
        }

        [data-theme="dark"] tbody tr:hover {
            background: rgba(3, 105, 161, 0.06);
        }

        /* ===== BADGES ===== */
        .badge {
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            white-space: nowrap;
        }

        .badge-urgent {
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid rgba(220, 38, 38, 0.15);
        }

        .badge-warning {
            background: var(--warning-bg);
            color: var(--warning);
            border: 1px solid rgba(217, 119, 6, 0.15);
        }

        .badge-success {
            background: var(--success-bg);
            color: var(--success);
            border: 1px solid rgba(5, 150, 105, 0.15);
        }

        .badge-neutral {
            background: var(--bg-body);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .badge-info {
            background: var(--info-bg);
            color: var(--info);
            border: 1px solid rgba(37, 99, 235, 0.15);
        }

        /* ===== DEV PANEL ===== */
        .dev-panel {
            width: 300px;
            background: #0d1117;
            color: #3fb950;
            font-family: 'JetBrains Mono', monospace;
            padding: 1rem;
            border-left: 1px solid #21262d;
            overflow-y: auto;
            display: none;
            font-size: 0.78rem;
        }

        .dev-panel.open {
            display: block;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #21262d;
            padding-bottom: 0.5rem;
        }

        .log-time {
            color: #484f58;
            font-size: 0.68rem;
        }

        /* ===== TOAST ===== */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 1000;
        }

        .toast {
            background: var(--primary);
            color: #fff;
            padding: 0.85rem 1.25rem;
            border-radius: var(--radius);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 3px solid var(--accent);
        }

        @keyframes slideIn {
            from {
                transform: translateX(120%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ===== ASSISTANT MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 22, 40, 0.6);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .chat-window {
            width: 500px;
            height: 600px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.18);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .chat-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-body);
        }

        .chat-body {
            flex: 1;
            padding: 1.25rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }

        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .msg-ai {
            align-self: flex-start;
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            border-bottom-left-radius: 3px;
        }

        .msg-user {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--primary-mid));
            color: white;
            border-bottom-right-radius: 3px;
        }

        .chat-input {
            flex: 1;
            padding: 0.7rem 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-body);
            color: var(--text-main);
            outline: none;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: var(--accent);
        }

        /* ===== LOGIN SCREEN ===== */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(160deg, #06101f 0%, #0d1b30 30%, #0a1628 60%, #091320 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        /* Subtle background pattern */
        .login-overlay::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at 20% 50%, rgba(3, 105, 161, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(37, 99, 235, 0.04) 0%, transparent 40%),
                radial-gradient(ellipse at 50% 80%, rgba(3, 105, 161, 0.03) 0%, transparent 40%);
            pointer-events: none;
        }

        .login-overlay.hidden-login {
            opacity: 0;
            transform: scale(1.03);
            pointer-events: none;
        }

        .login-container {
            width: 100%;
            max-width: 920px;
            padding: 2rem;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .login-brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .login-shield {
            width: 56px;
            height: 56px;
            object-fit: contain;
            filter: drop-shadow(0 2px 8px rgba(200, 149, 46, 0.2));
        }

        .login-brand h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
            letter-spacing: 3px;
            font-family: var(--font-heading);
        }

        .login-brand .accent-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            margin-left: 2px;
            vertical-align: super;
            animation: pulse-dot 2.5s ease infinite;
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.7);
            }
        }

        .login-subtitle {
            color: #64748b;
            font-size: 0.95rem;
            margin-bottom: 2.5rem;
            font-weight: 300;
            letter-spacing: 0.3px;
        }

        .login-subtitle strong {
            color: rgba(56, 189, 248, 0.9);
            font-weight: 500;
        }

        .login-roles {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
            margin-bottom: 2rem;
        }

        .role-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 2rem 1.5rem;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(12px);
            position: relative;
            overflow: hidden;
        }

        .role-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #0369A1, #0EA5E9);
            transform: scaleX(0);
            transition: transform 0.35s ease;
            transform-origin: left;
        }

        .role-card::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            background: radial-gradient(circle at 50% 0%, rgba(3, 105, 161, 0.08) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.35s;
        }

        .role-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(3, 105, 161, 0.3);
            transform: translateY(-6px);
            box-shadow: 0 16px 50px rgba(0, 0, 0, 0.35);
        }

        .role-card:hover::before {
            transform: scaleX(1);
        }

        .role-card:hover::after {
            opacity: 1;
        }

        .role-card.selected {
            background: rgba(3, 105, 161, 0.1);
            border-color: rgba(3, 105, 161, 0.4);
            box-shadow: 0 0 40px rgba(3, 105, 161, 0.12), inset 0 0 20px rgba(3, 105, 161, 0.04);
        }

        .role-card.selected::before {
            transform: scaleX(1);
        }

        .role-card.selected::after {
            opacity: 1;
        }

        .role-icon {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.6rem;
            position: relative;
            z-index: 1;
        }

        .role-card[data-role="ADMIN"] .role-icon {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.12), rgba(220, 38, 38, 0.04));
            color: #f87171;
        }

        .role-card[data-role="OPERATOR"] .role-icon {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.12), rgba(37, 99, 235, 0.04));
            color: #60a5fa;
        }

        .role-card[data-role="TECHNICIAN"] .role-icon {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.12), rgba(5, 150, 105, 0.04));
            color: #34d399;
        }

        .role-card h3 {
            color: #fff;
            font-size: 1.05rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            position: relative;
            z-index: 1;
            font-family: var(--font-heading);
        }

        .role-card p {
            color: #52617a;
            font-size: 0.78rem;
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }

        .login-form {
            max-width: 380px;
            margin: 0 auto;
            display: none;
            animation: fadeSlideUp 0.45s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .login-form.visible {
            display: block;
        }

        @keyframes fadeSlideUp {
            from {
                opacity: 0;
                transform: translateY(16px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-field {
            position: relative;
            margin-bottom: 1rem;
        }

        .login-field .material-symbols-outlined {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #4a5568;
            font-size: 1.15rem;
        }

        .login-field input {
            width: 100%;
            padding: 0.85rem 1rem 0.85rem 3rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--radius);
            background: rgba(255, 255, 255, 0.04);
            color: #fff;
            font-size: 0.93rem;
            font-family: var(--font-body);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
        }

        .login-field input::placeholder {
            color: #3c4b62;
        }

        .login-field input:focus {
            border-color: var(--accent);
            background: rgba(3, 105, 161, 0.04);
            box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.12);
        }

        .login-btn {
            width: 100%;
            padding: 0.9rem;
            border: none;
            border-radius: var(--radius);
            background: linear-gradient(135deg, #0369A1 0%, #0284C7 100%);
            color: #fff;
            font-size: 0.95rem;
            font-weight: 600;
            font-family: var(--font-body);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(3, 105, 161, 0.35);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-error {
            color: #f87171;
            font-size: 0.83rem;
            margin-top: 0.75rem;
            min-height: 1.3rem;
        }

        .login-hint {
            margin-top: 1.5rem;
            color: #3c4b62;
            font-size: 0.72rem;
        }

        .login-hint code {
            background: rgba(255, 255, 255, 0.06);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            color: #8896ab;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
        }

        .login-footer {
            margin-top: 2.5rem;
            color: #2c3a4f;
            font-size: 0.65rem;
            letter-spacing: 0.5px;
        }

        /* ===== LOGOUT ===== */
        .logout-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.55rem 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 8px;
            background: transparent;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.78rem;
            font-family: var(--font-body);
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 0.75rem;
        }

        .logout-btn:hover {
            background: rgba(220, 38, 38, 0.08);
            border-color: rgba(220, 38, 38, 0.2);
            color: #f87171;
        }

        /* ===== SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.25);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 116, 139, 0.4);
        }

        /* ===== TICKET TABS ===== */
        .ticket-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .ticket-tab {
            padding: 0.5rem 1.25rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: 0.15s;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            font-family: var(--font-body);
            font-weight: 500;
        }

        .ticket-tab:hover {
            color: var(--text-main);
        }

        .ticket-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* ===== FORM MODALS ===== */
        .form-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 22, 40, 0.6);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

        .form-modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .form-modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            width: 560px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.18);
        }

        .form-modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .form-modal-head h3 {
            font-size: 1.05rem;
            font-weight: 700;
        }

        .form-modal-body {
            padding: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .form-group label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.55rem 0.75rem;
            border-radius: var(--radius);
            font-family: var(--font-body);
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-modal-foot {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
        }

        .btn-modal {
            padding: 0.55rem 1.25rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-modal-primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .btn-modal-primary:hover {
            background: var(--accent-light);
        }

        .btn-modal-ghost {
            background: transparent;
            color: var(--text-muted);
        }

        .btn-modal-ghost:hover {
            background: var(--bg-body);
            color: var(--text-main);
        }

        /* ===== CHARTS ===== */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            box-shadow: var(--card-shadow);
        }

        .chart-card-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .bar-lbl {
            font-size: 0.75rem;
            color: var(--text-muted);
            width: 90px;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
        }

        .bar-track {
            flex: 1;
            background: var(--bg-body);
            border-radius: 3px;
            height: 18px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
        }

        .bar-val {
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
            width: 28px;
        }

        .donut-wrap {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* ===== SIDEBAR BADGE ===== */
        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: #fff;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 1px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ===== SEARCH TICKETS ===== */
        .search-tickets {
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 0.45rem 0.75rem;
            border-radius: var(--radius);
            font-family: var(--font-body);
            font-size: 0.85rem;
            width: 220px;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-tickets:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .search-tickets::placeholder {
            color: var(--text-muted);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 700px) {
            .login-roles {
                grid-template-columns: 1fr;
            }
        }

        /* ===== ACCESSIBILITY — WCAG AAA (UI/UX Pro Max) ===== */
        /* Focus-visible rings: 3px solid blue on all interactive elements */
        :focus-visible {
            outline: 3px solid var(--accent);
            outline-offset: 2px;
        }

        /* Remove default outline for mouse clicks but keep for keyboard */
        :focus:not(:focus-visible) {
            outline: none;
        }

        /* Cursor pointer on all interactive elements */
        button,
        .nav-item,
        .role-card,
        .ticket-tab,
        .logout-btn,
        [onclick],
        a,
        summary,
        select,
        input[type="checkbox"],
        input[type="radio"],
        label[for] {
            cursor: pointer;
        }

        /* Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Heading typography enforcement */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: var(--font-heading);
        }

        /* Dark mode stat-value gradient override */
        [data-theme="dark"] .stat-value {
            background: linear-gradient(135deg, #E2E8F0 0%, #94A3B8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>

<body data-theme="light">

    <!-- ===== LOGIN SCREEN ===== -->
    <div id="login-screen" class="login-overlay">
        <div class="login-container">
            <div class="login-brand">
                <img class="login-shield"
                    src="https://upload.wikimedia.org/wikipedia/commons/8/84/Bandera_de_la_Provincia_de_Santa_Fe.svg"
                    alt="Bandera Provincia de Santa Fe">
                <h1>SOJUS<span class="accent-dot"></span></h1>
            </div>
            <p class="login-subtitle">Poder Judicial — <strong>Provincia de Santa Fe</strong> &mdash; Sistema de Gestión
            </p>

            <div class="login-roles" id="login-roles">
                <div class="role-card" data-role="ADMIN" onclick="selectLoginRole('ADMIN')">
                    <div class="role-icon">
                        <span class="material-symbols-outlined">admin_panel_settings</span>
                    </div>
                    <h3>Administrador</h3>
                    <p>Gestión total del sistema, auditoría y configuración</p>
                </div>
                <div class="role-card" data-role="OPERATOR" onclick="selectLoginRole('OPERATOR')">
                    <div class="role-icon">
                        <span class="material-symbols-outlined">headset_mic</span>
                    </div>
                    <h3>Operador</h3>
                    <p>Mesa de ayuda, recepción de tickets y seguimiento</p>
                </div>
                <div class="role-card" data-role="TECHNICIAN" onclick="selectLoginRole('TECHNICIAN')">
                    <div class="role-icon">
                        <span class="material-symbols-outlined">engineering</span>
                    </div>
                    <h3>Técnico</h3>
                    <p>Atención en campo, inventario y resolución técnica</p>
                </div>
            </div>

            <div class="login-form" id="login-form">
                <div class="login-field">
                    <span class="material-symbols-outlined">person</span>
                    <input type="text" id="login-user" placeholder="Usuario" autocomplete="off">
                </div>
                <div class="login-field">
                    <span class="material-symbols-outlined">lock</span>
                    <input type="password" id="login-pass" placeholder="Contraseña"
                        onkeydown="if(event.key==='Enter') handleLogin()">
                </div>
                <button class="login-btn" onclick="handleLogin()">
                    <span class="material-symbols-outlined">login</span>
                    Iniciar Sesión
                </button>
                <div class="login-error" id="login-error"></div>
                <div class="login-hint" id="login-hint"></div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <img class="brand-shield"
                src="https://upload.wikimedia.org/wikipedia/commons/8/84/Bandera_de_la_Provincia_de_Santa_Fe.svg"
                alt="Bandera">
            <div class="brand-text">
                <span class="brand-name">SOJUS</span>
                <span class="brand-sub">Poder Judicial — Santa Fe</span>
            </div>
        </div>
        <nav class="nav-menu" id="sidebar-nav">
            <!-- Dynamic Content -->
        </nav>
        <div class="p-4" style="border-top: 1px solid rgba(255,255,255,0.1);">
            <div class="flex items-center gap-2 text-sm" style="color: #94a3b8;">
                <span id="user-avatar-icon" class="material-symbols-outlined">account_circle</span>
                <span id="user-display-name">jmartinez (Admin)</span>
            </div>
            <button class="logout-btn" onclick="logout()">
                <span class="material-symbols-outlined" style="font-size:1.1rem;">logout</span>
                Cerrar Sesión
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header class="app-header">
            <div class="flex items-center gap-4">
                <h2 id="page-title" class="font-bold text-lg">Dashboard Ejecutivo</h2>
            </div>

            <div class="omnisearch">
                <span class="material-symbols-outlined text-gray-400">search</span>
                <input type="text" placeholder="Buscar ticket, serie, inventario...">
                <span class="text-xs text-gray-400 mono">CTRL+K</span>
            </div>

            <div class="flex items-center gap-4">
                <!-- Role indicator (login-based, no longer a switcher) -->
                <span id="role-indicator" class="text-xs mono"
                    style="padding: 0.35rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; background: var(--bg-body); color: var(--text-muted);">Administrador</span>

                <button onclick="toggleDevPanel()" class="icon-btn" title="Toggle Dev Panel">
                    <span class="material-symbols-outlined">terminal</span>
                </button>
                <button onclick="toggleTheme()" class="icon-btn" title="Toggle Theme">
                    <span class="material-symbols-outlined">dark_mode</span>
                </button>
                <button class="icon-btn">
                    <span class="material-symbols-outlined">notifications</span>
                </button>
            </div>
        </header>

        <div id="content-area" class="view-container">
            <!-- Dynamic Content Injected Here -->
        </div>
    </main>

    <!-- Dev Panel (Right) -->
    <aside id="dev-panel" class="dev-panel">
        <div
            style="margin-bottom: 1rem; border-bottom: 1px solid #444; padding-bottom: 0.5rem; display: flex; justify-content: space-between;">
            <strong>DEV AUDIT LOG</strong>
            <small onclick="toggleDevPanel()" style="cursor: pointer;">[x]</small>
        </div>
        <div id="dev-logs">
            <!-- Logs go here -->
        </div>
    </aside>

    <!-- Toasts -->
    <div id="toast-container" class="toast-container"></div>

    <!-- AI Assistant Modal -->
    <div id="ai-modal" class="modal-overlay" onclick="if(event.target.id === 'ai-modal') closeAssistant()">
        <div class="chat-window">
            <div class="chat-header">
                <h3 class="font-bold text-lg">Asistente AI</h3>
                <button class="icon-btn" onclick="closeAssistant()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="chat-messages" class="chat-body">
                <div class="message msg-ai">Hola, soy tu asistente virtual. Descríbeme el problema y te ayudaré a crear
                    el ticket automáticamente.</div>
            </div>
            <div class="chat-footer">
                <input type="text" id="chat-input" class="chat-input" placeholder="Describe el problema..."
                    onkeydown="handleChatKey(event)">
                <button class="icon-btn" onclick="sendChatMessage()">
                    <span class="material-symbols-outlined">send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: NUEVO TICKET ===== -->
    <div id="modal-nuevo-ticket" class="form-modal-overlay"
        onclick="if(event.target===this) closeFormModal('modal-nuevo-ticket')">
        <div class="form-modal">
            <div class="form-modal-head">
                <h3><span class="material-symbols-outlined"
                        style="vertical-align:middle;margin-right:0.5rem;">confirmation_number</span>Nuevo Ticket de
                    Soporte</h3>
                <button class="icon-btn" onclick="closeFormModal('modal-nuevo-ticket')"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="form-modal-body">
                <div class="form-row">
                    <div class="form-group"><label>Juzgado / Dependencia</label>
                        <select id="nt-juzgado">
                            <option>Juz. Civil N°1</option>
                            <option>Juz. Penal N°2</option>
                            <option>Juz. Laboral N°3</option>
                            <option>Juz. Civil N°4</option>
                            <option>Data Center Central</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Prioridad</label>
                        <select id="nt-prioridad">
                            <option>ALTA</option>
                            <option selected>MEDIA</option>
                            <option>BAJA</option>
                        </select>
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group"><label>Asunto</label><input id="nt-asunto" type="text"
                            placeholder="Ej: PC no enciende en puesto 4"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Equipo Afectado (ID Inventario)</label><input id="nt-equipo"
                            type="text" placeholder="Ej: INV-PC-00432"></div>
                    <div class="form-group"><label>Técnico Asignado</label>
                        <select id="nt-tecnico">
                            <option value="--">— Sin asignar —</option>
                            <option>L. Gomez</option>
                            <option>M. Ruiz</option>
                        </select>
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group"><label>Descripción del problema</label><textarea id="nt-desc"
                            placeholder="Detalle el problema reportado..."></textarea></div>
                </div>
            </div>
            <div class="form-modal-foot">
                <button class="btn-modal btn-modal-ghost"
                    onclick="closeFormModal('modal-nuevo-ticket')">Cancelar</button>
                <button class="btn-modal btn-modal-primary" onclick="crearTicket()">✔ Crear Ticket</button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: NUEVO EQUIPO ===== -->
    <div id="modal-nuevo-equipo" class="form-modal-overlay"
        onclick="if(event.target===this) closeFormModal('modal-nuevo-equipo')">
        <div class="form-modal">
            <div class="form-modal-head">
                <h3><span class="material-symbols-outlined"
                        style="vertical-align:middle;margin-right:0.5rem;">devices</span>Registrar Equipo</h3>
                <button class="icon-btn" onclick="closeFormModal('modal-nuevo-equipo')"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="form-modal-body">
                <div class="form-row">
                    <div class="form-group"><label>Clase</label>
                        <select id="ne-clase">
                            <option>PC</option>
                            <option>Monitor</option>
                            <option>Impresora</option>
                            <option>Servidor</option>
                            <option>Red</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Tipo</label>
                        <select id="ne-tipo">
                            <option>Desktop</option>
                            <option>All-in-One</option>
                            <option>Notebook</option>
                            <option>Láser Mono</option>
                            <option>Rack 2U</option>
                            <option>24 pulgadas</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Marca</label><input id="ne-marca" type="text"
                            placeholder="Ej: HP, Dell, Lenovo"></div>
                    <div class="form-group"><label>Modelo</label><input id="ne-modelo" type="text"
                            placeholder="Ej: ProDesk 400 G7"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Nº Serie</label><input id="ne-serie" type="text"
                            placeholder="Número de serie"></div>
                    <div class="form-group"><label>Nº Inventario</label><input id="ne-inv" type="text"
                            placeholder="Ej: INV-PC-00500"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Juzgado / Dependencia</label>
                        <select id="ne-juzgado">
                            <option>Juz. Civil N°1</option>
                            <option>Juz. Penal N°2</option>
                            <option>Juz. Laboral N°3</option>
                            <option>Juz. Civil N°4</option>
                            <option>Data Center Central</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Puesto de Trabajo</label><input id="ne-puesto" type="text"
                            placeholder="Ej: Escritorio 3A"></div>
                </div>
            </div>
            <div class="form-modal-foot">
                <button class="btn-modal btn-modal-ghost"
                    onclick="closeFormModal('modal-nuevo-equipo')">Cancelar</button>
                <button class="btn-modal btn-modal-primary" onclick="registrarEquipo()">✔ Registrar</button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: DETALLE TICKET ===== -->
    <div id="modal-detalle-ticket" class="form-modal-overlay"
        onclick="if(event.target===this) closeFormModal('modal-detalle-ticket')">
        <div class="form-modal" style="width:600px;">
            <div class="form-modal-head">
                <h3 id="det-titulo">Detalle del Ticket</h3>
                <button class="icon-btn" onclick="closeFormModal('modal-detalle-ticket')"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="form-modal-body">
                <div id="det-info"
                    style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;font-size:0.9rem;margin-bottom:1rem;">
                </div>
                <div id="det-bitacora" style="margin-bottom:1rem;"></div>
                <div style="margin-bottom:1rem;">
                    <label
                        style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);font-weight:600;display:block;margin-bottom:0.3rem;">Cambiar
                        Estado</label>
                    <select id="det-estado"
                        style="width:100%;background:var(--bg-body);border:1px solid var(--border);color:var(--text-main);padding:0.55rem 0.75rem;border-radius:var(--radius);font-family:'Outfit',sans-serif;font-size:0.9rem;">
                        <option>Solicitado</option>
                        <option>Asignado</option>
                        <option>En Curso</option>
                        <option>Cerrado</option>
                    </select>
                </div>
                <div id="det-tecnico-wrap" style="margin-bottom:1rem;">
                    <label
                        style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);font-weight:600;display:block;margin-bottom:0.3rem;">Asignar
                        Técnico</label>
                    <select id="det-tecnico"
                        style="width:100%;background:var(--bg-body);border:1px solid var(--border);color:var(--text-main);padding:0.55rem 0.75rem;border-radius:var(--radius);font-family:'Outfit',sans-serif;font-size:0.9rem;">
                        <option value="--">— Sin asignar —</option>
                        <option>L. Gomez</option>
                        <option>M. Ruiz</option>
                    </select>
                </div>
                <div>
                    <label
                        style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-muted);font-weight:600;display:block;margin-bottom:0.3rem;">Agregar
                        nota a bitácora</label>
                    <textarea id="det-nota" placeholder="Descripción del trabajo realizado..."
                        style="width:100%;background:var(--bg-body);border:1px solid var(--border);color:var(--text-main);padding:0.55rem 0.75rem;border-radius:var(--radius);font-family:'Outfit',sans-serif;font-size:0.9rem;min-height:80px;resize:vertical;"></textarea>
                </div>
            </div>
            <div class="form-modal-foot">
                <button class="btn-modal btn-modal-ghost"
                    onclick="closeFormModal('modal-detalle-ticket')">Cerrar</button>
                <button class="btn-modal btn-modal-primary" onclick="actualizarTicket()">✔ Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        // --- MOCK DATA (Aligned to PPT Specification) ---
        const MOCK_DB = {
            tickets: [
                { id: 'CAS-2026-001', subject: 'Falla disco duro Servidor Archivos', status: 'En Curso', priority: 'ALTA', juzgado: 'Juz. Civil N°1', assignedTo: 'L. Gomez', equipoId: 'INV-SRV-00001', updated: '10m', bitacora: [{ fecha: '2026-02-19 09:00', autor: 'M. Operadora', nota: 'Ticket creado' }, { fecha: '2026-02-19 09:15', autor: 'L. Gomez', nota: 'Asignado. Revisando servidor en sala.' }, { fecha: '2026-02-19 10:00', autor: 'L. Gomez', nota: 'Disco S/N SRV001 presenta sectores dañados. Solicitando reemplazo bajo contrato CON-SRV-2021-09.' }] },
                { id: 'CAS-2026-002', subject: 'Reemplazo Toner Impresora Mesa Entradas', status: 'Solicitado', priority: 'BAJA', juzgado: 'Juz. Laboral N°3', assignedTo: '--', equipoId: 'INV-IMP-00055', updated: '1h', bitacora: [{ fecha: '2026-02-19 08:30', autor: 'Sistema', nota: 'Ticket creado vía portal de usuario' }] },
                { id: 'CAS-2026-003', subject: 'Sin conexión a internet despacho Juez', status: 'Asignado', priority: 'ALTA', juzgado: 'Juz. Penal N°2', assignedTo: 'M. Ruiz', equipoId: 'INV-PC-00433', updated: '2h', bitacora: [{ fecha: '2026-02-19 07:45', autor: 'M. Operadora', nota: 'Ticket creado por llamado telefónico' }, { fecha: '2026-02-19 08:00', autor: 'M. Operadora', nota: 'Asignado a M. Ruiz' }] },
                { id: 'CAS-2026-004', subject: 'Instalación LexDoctor nuevo puesto', status: 'Cerrado', priority: 'MEDIA', juzgado: 'Juz. Civil N°4', assignedTo: 'L. Gomez', equipoId: 'INV-PC-00434', updated: '1d', bitacora: [{ fecha: '2026-02-18 10:00', autor: 'Sistema', nota: 'Ticket creado' }, { fecha: '2026-02-18 11:00', autor: 'L. Gomez', nota: 'Software instalado correctamente' }, { fecha: '2026-02-18 11:30', autor: 'L. Gomez', nota: 'Cerrado. Verificado con usuario.' }] },
                { id: 'CAS-2026-005', subject: 'Monitor sin imagen puesto Secretaría', status: 'En Curso', priority: 'MEDIA', juzgado: 'Juz. Civil N°1', assignedTo: 'M. Ruiz', equipoId: 'INV-MON-00112', updated: '3h', bitacora: [{ fecha: '2026-02-19 06:00', autor: 'M. Operadora', nota: 'Ticket creado' }, { fecha: '2026-02-19 07:00', autor: 'M. Ruiz', nota: 'Revisando cable y conexión' }] },
                { id: 'CAS-2026-006', subject: 'Actualización antivirus masiva', status: 'Cerrado', priority: 'BAJA', juzgado: 'Todas las sedes', assignedTo: 'L. Gomez', equipoId: '--', updated: '3d', bitacora: [{ fecha: '2026-02-16 09:00', autor: 'Admin', nota: 'Tarea programada' }, { fecha: '2026-02-16 18:00', autor: 'L. Gomez', nota: 'Actualización completada en 47 equipos' }] },
            ],
            hardware: [
                { id: 'INV-PC-00432', clase: 'PC', tipo: 'Desktop', brand: 'HP', model: 'ProDesk 400 G7', serial: 'MXL12345', juzgado: 'Juz. Civil N°1', puesto: 'Puesto 1 - Secretaría', status: 'Operativo', contract: 'CON-HW-2023-01' },
                { id: 'INV-PC-00433', clase: 'PC', tipo: 'All-in-One', brand: 'Lenovo', model: 'ThinkCentre M90a', serial: 'PF3N8K2', juzgado: 'Juz. Penal N°2', puesto: 'Despacho Juez', status: 'Operativo', contract: 'CON-HW-2023-01' },
                { id: 'INV-PC-00434', clase: 'PC', tipo: 'Desktop', brand: 'HP', model: 'ProDesk 400 G7', serial: 'MXL12399', juzgado: 'Juz. Civil N°4', puesto: 'Puesto 2 - Mesa Entradas', status: 'Operativo', contract: 'CON-HW-2023-01' },
                { id: 'INV-MON-00112', clase: 'Monitor', tipo: '24 pulgadas', brand: 'Dell', model: 'P2419H', serial: 'CN0123', juzgado: 'Juz. Civil N°1', puesto: 'Puesto 1 - Secretaría', status: 'En Reparación', contract: 'CON-HW-2023-01' },
                { id: 'INV-IMP-00055', clase: 'Impresora', tipo: 'Láser Mono', brand: 'Lexmark', model: 'MS810dn', serial: '701XFGT', juzgado: 'Juz. Laboral N°3', puesto: 'Mesa de Entradas', status: 'Operativo', contract: 'CON-IMP-2022-05' },
                { id: 'INV-SRV-00001', clase: 'Servidor', tipo: 'Rack 2U', brand: 'Dell', model: 'PowerEdge R740', serial: 'SRV001DC', juzgado: 'Data Center Central', puesto: 'Rack A-03', status: 'Operativo', contract: 'CON-SRV-2021-09' },
            ],
            software: [
                { id: 'SW-001', name: 'LexDoctor', version: '12.5', tipo: 'Gestión Jurídica', licencia: 'Perpetua', equipoId: 'INV-PC-00432', juzgado: 'Juz. Civil N°1', status: 'Activo' },
                { id: 'SW-002', name: 'Microsoft Office 365', version: '2024', tipo: 'Ofimática', licencia: 'Suscripción Anual', equipoId: 'INV-PC-00432', juzgado: 'Juz. Civil N°1', status: 'Activo' },
                { id: 'SW-003', name: 'ESET Endpoint Security', version: '10.1', tipo: 'Antivirus', licencia: 'Suscripción Anual', equipoId: 'INV-PC-00433', juzgado: 'Juz. Penal N°2', status: 'Activo' },
                { id: 'SW-004', name: 'Adobe Acrobat Pro', version: '2023', tipo: 'PDF/Documentos', licencia: 'Perpetua', equipoId: 'INV-PC-00434', juzgado: 'Juz. Civil N°4', status: 'Activo' },
                { id: 'SW-005', name: 'Windows 11 Pro', version: '23H2', tipo: 'Sistema Operativo', licencia: 'OEM', equipoId: 'INV-PC-00432', juzgado: 'Juz. Civil N°1', status: 'Activo' },
                { id: 'SW-006', name: 'Lex Doctor', version: '11.0', tipo: 'Gestión Jurídica', licencia: 'Perpetua', equipoId: 'INV-PC-00434', juzgado: 'Juz. Civil N°4', status: 'Inactivo' },
            ],
            contracts: [
                { id: 'CON-HW-2023-01', name: 'Mant. PC y Monitores', provider: 'TecnoGlobal S.A.', service: 'Mantenimiento preventivo/correctivo PCs y Monitores', coverage: 'Hardware', start: '2023-01-01', end: '2026-12-31', status: 'Vigente', alertDays: 30 },
                { id: 'CON-IMP-2022-05', name: 'Alquiler Impresoras', provider: 'PrintSolutions S.R.L.', service: 'Alquiler y mantenimiento de impresoras láser', coverage: 'Hardware + Insumos', start: '2022-05-01', end: '2026-03-15', status: 'Por Vencer', alertDays: 30 },
                { id: 'CON-SRV-2021-09', name: 'Soporte Servidores 24/7', provider: 'DataCorp Argentina', service: 'Soporte crítico 24/7 para servidores de producción', coverage: 'Hardware + Software', start: '2021-09-01', end: '2026-02-28', status: 'Urgente', alertDays: 15 },
                { id: 'CON-SW-2024-01', name: 'Licencias Office 365', provider: 'Microsoft Argentina', service: 'Suscripción Microsoft 365 Business', coverage: 'Software', start: '2024-01-01', end: '2027-01-01', status: 'Vigente', alertDays: 60 },
            ],
            locations: [
                { id: 'CIRC-1', name: '1ra Circunscripción', type: 'Circunscripción', icon: 'public', parent: null },
                { id: 'CIRC-2', name: '2da Circunscripción', type: 'Circunscripción', icon: 'public', parent: null },
                { id: 'DIST-SF', name: 'Distrito Judicial Santa Fe', type: 'Distrito', icon: 'map', parent: 'CIRC-1' },
                { id: 'DIST-ROS', name: 'Distrito Judicial Rosario', type: 'Distrito', icon: 'map', parent: 'CIRC-2' },
                { id: 'CIU-SF', name: 'Ciudad de Santa Fe', type: 'Ciudad', icon: 'location_city', parent: 'DIST-SF' },
                { id: 'EDIF-TRIB', name: 'Palacio de Tribunales', type: 'Edificio', icon: 'domain', parent: 'CIU-SF' },
                { id: 'EDIF-ANEX', name: 'Anexo Tribunales Penal', type: 'Edificio', icon: 'domain', parent: 'CIU-SF' },
                { id: 'JUZ-CIV-1', name: 'Juz. Civil y Comercial N°1', type: 'Juzgado', icon: 'gavel', parent: 'EDIF-TRIB' },
                { id: 'JUZ-CIV-4', name: 'Juz. Civil y Comercial N°4', type: 'Juzgado', icon: 'gavel', parent: 'EDIF-TRIB' },
                { id: 'JUZ-LAB-3', name: 'Juz. Laboral N°3', type: 'Juzgado', icon: 'gavel', parent: 'EDIF-TRIB' },
                { id: 'JUZ-PEN-2', name: 'Juz. Penal N°2', type: 'Juzgado', icon: 'gavel', parent: 'EDIF-ANEX' },
            ],
            users: [
                { user: 'jmartinez', nombre: 'Juan Martinez', rol: 'Administrador IT', dep: 'Secretaría General', ultimo: '2026-02-19 10:42', activo: true },
                { user: 'moperadora', nombre: 'Marta Operadora', rol: 'Operador Mesa Ayuda', dep: 'Mesa de Entradas', ultimo: '2026-02-19 09:15', activo: true },
                { user: 'lgomez', nombre: 'L. Gomez', rol: 'Técnico de Soporte', dep: 'Juz. Civil N°1', ultimo: '2026-02-19 10:00', activo: true },
                { user: 'mruiz', nombre: 'M. Ruiz', rol: 'Técnico de Soporte', dep: 'Juz. Penal N°2', ultimo: '2026-02-18 17:48', activo: true },
                { user: 'jtorres', nombre: 'Juan Torres', rol: 'Juez / Solicitante', dep: 'Juz. Civil N°4', ultimo: '2026-02-14 14:00', activo: true },
                { user: 'psanchez', nombre: 'Patricia Sánchez', rol: 'Secretaria', dep: 'Secretaría General', ultimo: '2026-02-12 10:00', activo: false },
            ],
            auditLog: [
                { id: 1, fecha: '2026-02-19 10:05', entidad: 'Activo', entityId: 'INV-MON-00112', campo: 'Estado', valorAnterior: 'Operativo', valorNuevo: 'En Reparación', autor: 'L. Gomez' },
                { id: 2, fecha: '2026-02-19 09:15', entidad: 'Caso', entityId: 'CAS-2026-001', campo: 'Asignado', valorAnterior: '--', valorNuevo: 'L. Gomez', autor: 'M. Operadora' },
                { id: 3, fecha: '2026-02-18 11:30', entidad: 'Caso', entityId: 'CAS-2026-004', campo: 'Estado', valorAnterior: 'En Curso', valorNuevo: 'Cerrado', autor: 'L. Gomez' },
                { id: 4, fecha: '2026-02-18 10:00', entidad: 'Activo', entityId: 'INV-PC-00434', campo: 'Juzgado', valorAnterior: 'Depósito Central', valorNuevo: 'Juz. Civil N°4', autor: 'L. Gomez' },
                { id: 5, fecha: '2026-02-17 14:22', entidad: 'Contrato', entityId: 'CON-IMP-2022-05', campo: 'Estado', valorAnterior: 'Vigente', valorNuevo: 'Por Vencer', autor: 'Sistema' },
                { id: 6, fecha: '2026-02-16 18:00', entidad: 'Software', entityId: 'SW-006', campo: 'Estado', valorAnterior: 'Activo', valorNuevo: 'Inactivo', autor: 'L. Gomez' },
            ]
        };

        // --- APP STATE ---
        let currentView = 'dashboard';
        let currentUser = {
            id: 'jmartinez',
            name: 'Juan Martinez',
            role: 'ADMIN', // ADMIN, OPERATOR, TECHNICIAN
            avatar: 'account_circle'
        };

        const ROLES = {
            ADMIN: { label: 'Administrador', permissions: ['all'] },
            OPERATOR: { label: 'Operador (Mesa Ayuda)', permissions: ['dashboard', 'tickets', 'inventory', 'software', 'contracts', 'locations'] },
            TECHNICIAN: { label: 'Técnico', permissions: ['tickets-assigned'] }
        };

        // --- RENDER FUNCTIONS ---

        function renderDashboard() {
            const openTickets = MOCK_DB.tickets.filter(t => t.status !== 'Cerrado').length;
            const closedMonth = MOCK_DB.tickets.filter(t => t.status === 'Cerrado').length;
            const highPriority = MOCK_DB.tickets.filter(t => t.priority === 'ALTA' && t.status !== 'Cerrado').length;
            const urgentContracts = MOCK_DB.contracts.filter(c => c.status === 'Urgente' || c.status === 'Por Vencer').length;

            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="text-muted text-xs font-bold uppercase">Casos Abiertos</span>
                        <span class="stat-value">${openTickets}</span>
                        <div class="text-xs text-muted">Solicitados / Asignados / En Curso</div>
                    </div>
                    <div class="stat-card">
                        <span class="text-muted text-xs font-bold uppercase">Cerrados este Mes</span>
                        <span class="stat-value" style="color: var(--success);">${closedMonth}</span>
                        <div class="text-xs text-muted">Casos resueltos</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--danger);">
                        <span class="text-xs font-bold uppercase" style="color: var(--danger);">Prioridad Alta</span>
                        <span class="stat-value" style="color: var(--danger);">${highPriority}</span>
                        <div class="text-xs text-muted">Requieren atención urgente</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--warning);">
                        <span class="text-xs font-bold uppercase" style="color: var(--warning);">Contratos Urgentes</span>
                        <span class="stat-value" style="color: var(--warning);">${urgentContracts}</span>
                        <div class="text-xs text-muted">Urgentes / Por Vencer</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div>
                        <h3 class="font-bold text-lg" style="margin-bottom: 1rem;">Tickets Recientes</h3>
                        <div class="data-table-container">
                            <table>
                                <thead><tr><th>ID</th><th>Asunto</th><th>Prioridad</th><th>Estado</th></tr></thead>
                                <tbody>
                                    ${MOCK_DB.tickets.slice(0, 4).map(t => `
                                    <tr>
                                        <td class="mono font-bold text-xs">${t.id}</td>
                                        <td class="text-sm">${t.subject}</td>
                                        <td>${renderPriorityBadge(t.priority)}</td>
                                        <td>${renderStatusBadge(t.status)}</td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg" style="margin-bottom: 1rem;">Actividad Reciente (Auditoría)</h3>
                        <div class="data-table-container">
                            <table>
                                <thead><tr><th>Fecha</th><th>Entidad</th><th>Cambio</th><th>Autor</th></tr></thead>
                                <tbody>
                                    ${MOCK_DB.auditLog.slice(0, 4).map(a => `
                                    <tr>
                                        <td class="mono text-xs">${a.fecha}</td>
                                        <td class="text-sm">${a.entidad} <span class="mono text-xs text-muted">${a.entityId}</span></td>
                                        <td class="text-sm">${a.campo}: <span style="text-decoration:line-through;color:var(--danger);">${a.valorAnterior}</span> → <span style="color:var(--success);">${a.valorNuevo}</span></td>
                                        <td class="text-sm">${a.autor}</td>
                                    </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-card-title">Tickets por Juzgado</div>
                        <div class="bar-chart">
                            ${(() => {
                    const counts = {};
                    MOCK_DB.tickets.filter(t => t.status !== 'Cerrado').forEach(t => { counts[t.juzgado] = (counts[t.juzgado] || 0) + 1; });
                    const max = Math.max(...Object.values(counts), 1);
                    return Object.entries(counts).map(([j, c]) => `
                                    <div class="bar-row"><div class="bar-lbl">${j.length > 14 ? j.substring(0, 14) + '…' : j}</div><div class="bar-track"><div class="bar-fill" style="width:${(c / max) * 100}%"></div></div><div class="bar-val">${c}</div></div>
                                `).join('');
                })()}
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">Estado de Tickets</div>
                        <div class="donut-wrap">
                            ${(() => {
                    const sol = MOCK_DB.tickets.filter(t => t.status === 'Solicitado').length;
                    const asg = MOCK_DB.tickets.filter(t => t.status === 'Asignado').length;
                    const enc = MOCK_DB.tickets.filter(t => t.status === 'En Curso').length;
                    const cer = MOCK_DB.tickets.filter(t => t.status === 'Cerrado').length;
                    const total = sol + asg + enc + cer || 1;
                    const r = 35, c = Math.PI * 2 * r;
                    const s1 = (sol / total) * c, s2 = (asg / total) * c, s3 = (enc / total) * c, s4 = (cer / total) * c;
                    let off = c * 0.25;
                    const d1 = off; off -= s1;
                    const d2 = off; off -= s2;
                    const d3 = off; off -= s3;
                    const d4 = off;
                    return `
                                <svg width="100" height="100" viewBox="0 0 90 90">
                                    <circle cx="45" cy="45" r="${r}" fill="none" stroke="var(--border)" stroke-width="12"/>
                                    <circle cx="45" cy="45" r="${r}" fill="none" stroke="var(--info)" stroke-width="12" stroke-dasharray="${s1} ${c - s1}" stroke-dashoffset="${d1}" stroke-linecap="round"/>
                                    <circle cx="45" cy="45" r="${r}" fill="none" stroke="#8b5cf6" stroke-width="12" stroke-dasharray="${s2} ${c - s2}" stroke-dashoffset="${d2}" stroke-linecap="round"/>
                                    <circle cx="45" cy="45" r="${r}" fill="none" stroke="var(--warning)" stroke-width="12" stroke-dasharray="${s3} ${c - s3}" stroke-dashoffset="${d3}" stroke-linecap="round"/>
                                    <circle cx="45" cy="45" r="${r}" fill="none" stroke="var(--success)" stroke-width="12" stroke-dasharray="${s4} ${c - s4}" stroke-dashoffset="${d4}" stroke-linecap="round"/>
                                </svg>
                                <div class="donut-legend">
                                    <div class="legend-item"><div class="legend-dot" style="background:var(--info)"></div>Solicitado (${sol})</div>
                                    <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6"></div>Asignado (${asg})</div>
                                    <div class="legend-item"><div class="legend-dot" style="background:var(--warning)"></div>En Curso (${enc})</div>
                                    <div class="legend-item"><div class="legend-dot" style="background:var(--success)"></div>Cerrado (${cer})</div>
                                </div>`;
                })()}
                        </div>
                    </div>
                </div>
            `;
        }

        let currentTicketFilter = 'all';
        let ticketSearchQuery = '';

        function renderTickets() {
            const isTech = currentUser.role === 'TECHNICIAN';
            let tickets = isTech
                ? MOCK_DB.tickets.filter(t => t.assignedTo === currentUser.name)
                : MOCK_DB.tickets;

            // Apply status filter
            if (currentTicketFilter !== 'all') {
                tickets = tickets.filter(t => t.status === currentTicketFilter);
            }
            // Apply search
            if (ticketSearchQuery) {
                const q = ticketSearchQuery.toLowerCase();
                tickets = tickets.filter(t => t.id.toLowerCase().includes(q) || t.subject.toLowerCase().includes(q) || t.juzgado.toLowerCase().includes(q));
            }

            return `
                ${isTech ? `
                <div style="background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(99,102,241,0.02)); border: 1px solid rgba(99,102,241,0.2); border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="material-symbols-outlined" style="color: var(--info);">assignment_ind</span>
                    <span class="text-sm">Mostrando únicamente tus <strong>${tickets.length} caso(s) asignados</strong>.</span>
                </div>` : `
                <div class="flex justify-between items-center" style="margin-bottom: 1rem;">
                    <div class="flex gap-2 items-center">
                        <input class="search-tickets" placeholder="🔍 Buscar ticket..." value="${ticketSearchQuery}" oninput="ticketSearchQuery=this.value;document.getElementById('content-area').innerHTML=renderTickets();">
                    </div>
                    <div class="flex gap-2">
                        <button class="badge" onclick="openAssistant()" style="padding: 0.6rem 1rem; color: #fff; background: var(--info); display: flex; align-items: center; gap: 0.5rem; border: none; cursor: pointer; border-radius: 8px;">
                            <span class="material-symbols-outlined" style="font-size:1.1rem;">smart_toy</span>
                            Asistente AI
                        </button>
                        <button class="badge" onclick="openFormModal('modal-nuevo-ticket')" style="padding: 0.6rem 1rem; color: #fff; background: var(--accent); display: flex; align-items: center; gap: 0.5rem; border: none; cursor: pointer; border-radius: 8px;">
                            <span class="material-symbols-outlined" style="font-size:1.1rem;">add</span>
                            Nuevo Ticket
                        </button>
                    </div>
                </div>

                <div class="charts-row" style="margin-bottom:1.5rem;">
                    <div class="chart-card">
                        <div class="chart-card-title">Tickets por Dependencia</div>
                        <div class="bar-chart">
                            ${(() => {
                    const counts = {};
                    MOCK_DB.tickets.filter(t => t.status !== 'Cerrado').forEach(t => { counts[t.juzgado] = (counts[t.juzgado] || 0) + 1; });
                    const max = Math.max(...Object.values(counts), 1);
                    return Object.entries(counts).map(([j, c]) => `
                                    <div class="bar-row"><div class="bar-lbl">${j.length > 14 ? j.substring(0, 14) + '…' : j}</div><div class="bar-track"><div class="bar-fill" style="width:${(c / max) * 100}%"></div></div><div class="bar-val">${c}</div></div>
                                `).join('');
                })()}
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-title">Estado de Tickets</div>
                        <div class="donut-wrap">
                            ${(() => {
                    const sol = MOCK_DB.tickets.filter(t => t.status === 'Solicitado').length;
                    const asg = MOCK_DB.tickets.filter(t => t.status === 'Asignado').length;
                    const enc = MOCK_DB.tickets.filter(t => t.status === 'En Curso').length;
                    const cer = MOCK_DB.tickets.filter(t => t.status === 'Cerrado').length;
                    const total = sol + asg + enc + cer || 1;
                    const r = 35, circ = Math.PI * 2 * r;
                    const s1 = (sol / total) * circ, s2 = (asg / total) * circ, s3 = (enc / total) * circ, s4 = (cer / total) * circ;
                    let off = circ * 0.25;
                    const d1 = off; off -= s1;
                    const d2 = off; off -= s2;
                    const d3 = off; off -= s3;
                    const d4 = off;
                    return `
                                <svg width="100" height="100" viewBox="0 0 90 90">
                                    <circle cx="45" cy="45" r="${r}" fill="none" stroke="var(--border)" stroke-width="12"/>
                                    <circle cx="45" cy="45" r="${r}" fill="none" stroke="var(--info)" stroke-width="12" stroke-dasharray="${s1} ${circ - s1}" stroke-dashoffset="${d1}" stroke-linecap="round"/>
                                    <circle cx="45" cy="45" r="${r}" fill="none" stroke="#f59e0b" stroke-width="12" stroke-dasharray="${s2} ${circ - s2}" stroke-dashoffset="${d2}" stroke-linecap="round"/>
                                    <circle cx="45" cy="45" r="${r}" fill="none" stroke="#f97316" stroke-width="12" stroke-dasharray="${s3} ${circ - s3}" stroke-dashoffset="${d3}" stroke-linecap="round"/>
                                    <circle cx="45" cy="45" r="${r}" fill="none" stroke="var(--success)" stroke-width="12" stroke-dasharray="${s4} ${circ - s4}" stroke-dashoffset="${d4}" stroke-linecap="round"/>
                                </svg>
                                <div class="donut-legend">
                                    <div class="legend-item"><div class="legend-dot" style="background:var(--info)"></div>Abierto (${sol})</div>
                                    <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div>Asignado (${asg})</div>
                                    <div class="legend-item"><div class="legend-dot" style="background:#f97316"></div>En Curso (${enc})</div>
                                    <div class="legend-item"><div class="legend-dot" style="background:var(--success)"></div>Cerrado (${cer})</div>
                                </div>`;
                })()}
                        </div>
                    </div>
                </div>

                <div style="margin-bottom:1.5rem;">
                    <div class="flex justify-between items-center" style="margin-bottom:0.75rem;">
                        <h3 class="font-bold" style="font-size:0.95rem;">Últimos tickets registrados</h3>
                        <button onclick="filterTicketsByStatus('all')" style="background:none;border:1px solid var(--border);color:var(--text-muted);padding:0.35rem 0.75rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-family:'Outfit',sans-serif;">Ver todos →</button>
                    </div>
                    <div class="data-table-container">
                        <table>
                            <thead><tr>
                                <th>Nº Ticket</th><th>Asunto</th><th>Dependencia</th><th>Prioridad</th><th>Estado</th>
                            </tr></thead>
                            <tbody>
                                ${MOCK_DB.tickets.slice(0, 5).map(t => `
                                <tr>
                                    <td class="mono font-bold text-xs">${t.id}</td>
                                    <td>${t.subject}</td>
                                    <td class="text-sm">${t.juzgado}</td>
                                    <td>${renderPriorityBadge(t.priority)}</td>
                                    <td>${renderStatusBadge(t.status)}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="ticket-tabs">
                    <button class="ticket-tab ${currentTicketFilter === 'all' ? 'active' : ''}" onclick="filterTicketsByStatus('all')">Todos</button>
                    <button class="ticket-tab ${currentTicketFilter === 'Solicitado' ? 'active' : ''}" onclick="filterTicketsByStatus('Solicitado')">Solicitados</button>
                    <button class="ticket-tab ${currentTicketFilter === 'Asignado' ? 'active' : ''}" onclick="filterTicketsByStatus('Asignado')">Asignados</button>
                    <button class="ticket-tab ${currentTicketFilter === 'En Curso' ? 'active' : ''}" onclick="filterTicketsByStatus('En Curso')">En Curso</button>
                    <button class="ticket-tab ${currentTicketFilter === 'Cerrado' ? 'active' : ''}" onclick="filterTicketsByStatus('Cerrado')">Cerrados</button>
                </div>`}
                <div class="data-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>N° Caso</th>
                                <th>Asunto</th>
                                <th>Juzgado</th>
                                <th>Equipo Afectado</th>
                                <th>Prioridad</th>
                                <th>Estado</th>
                                ${!isTech ? '<th>Asignado</th>' : ''}
                                <th>Act.</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tickets.length === 0 ? `<tr><td colspan="9" style="text-align:center;padding:2rem;" class="text-muted">No se encontraron casos.</td></tr>` : tickets.map(t => `
                                <tr>
                                    <td class="mono font-bold text-xs">${t.id}</td>
                                    <td>${t.subject}</td>
                                    <td class="text-sm">${t.juzgado}</td>
                                    <td class="mono text-xs">${t.equipoId}</td>
                                    <td>${renderPriorityBadge(t.priority)}</td>
                                    <td>${renderStatusBadge(t.status)}</td>
                                    ${!isTech ? `<td class="text-sm">${t.assignedTo}</td>` : ''}
                                    <td class="text-muted text-xs">${t.updated}</td>
                                    <td><button class="text-xs font-bold" style="color:var(--accent);background:none;border:none;cursor:pointer;" onclick="abrirDetalleTicket('${t.id}')">Ver →</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function filterTicketsByStatus(status) {
            currentTicketFilter = status;
            document.getElementById('content-area').innerHTML = renderTickets();
        }

        function renderInventory() {
            return `
                <div class="flex justify-between items-center" style="margin-bottom: 1rem;">
                    <div class="flex gap-2">
                        <button class="badge badge-neutral" style="padding: 0.5rem 1rem;">Filtro: Juzgado</button>
                        <button class="badge badge-neutral" style="padding: 0.5rem 1rem;">Filtro: Clase</button>
                        <button class="badge badge-neutral" style="padding: 0.5rem 1rem;">Filtro: Estado</button>
                    </div>
                    ${currentUser.role !== 'OPERATOR' ? `<button class="badge badge-success" onclick="openFormModal('modal-nuevo-equipo')" style="padding: 0.5rem 1rem; color: #fff; background: var(--success); border:none; cursor:pointer;">+ Nuevo Activo</button>` : ''}
                </div>
                <div class="data-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>N° Inventario</th>
                                <th>Clase</th>
                                <th>Tipo</th>
                                <th>Marca / Modelo</th>
                                <th>N° Serie</th>
                                <th>Juzgado</th>
                                <th>Puesto de Trabajo</th>
                                <th>Contrato</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${MOCK_DB.hardware.map(i => `
                                <tr>
                                    <td class="mono font-bold text-xs">${i.id}</td>
                                    <td>${i.clase}</td>
                                    <td class="text-sm">${i.tipo}</td>
                                    <td>${i.brand} ${i.model}</td>
                                    <td class="mono text-xs">${i.serial}</td>
                                    <td class="text-sm">${i.juzgado}</td>
                                    <td class="text-sm">${i.puesto}</td>
                                    <td class="mono text-xs text-muted">${i.contract || '-'}</td>
                                    <td><span class="badge ${i.status === 'Operativo' ? 'badge-success' : 'badge-warning'}">${i.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderSoftware() {
            return `
                <div class="flex justify-between items-center" style="margin-bottom: 1rem;">
                    <div class="flex gap-2">
                        <button class="badge badge-neutral" style="padding: 0.5rem 1rem;">Filtro: Tipo</button>
                        <button class="badge badge-neutral" style="padding: 0.5rem 1rem;">Filtro: Licencia</button>
                    </div>
                </div>
                <div class="data-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Software</th>
                                <th>Versión</th>
                                <th>Tipo</th>
                                <th>Licencia</th>
                                <th>Equipo Asignado</th>
                                <th>Juzgado</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${MOCK_DB.software.map(s => `
                                <tr style="${s.status === 'Inactivo' ? 'opacity:0.5;' : ''}">
                                    <td class="mono font-bold text-xs">${s.id}</td>
                                    <td class="font-bold">${s.name}</td>
                                    <td class="mono text-xs">${s.version}</td>
                                    <td class="text-sm">${s.tipo}</td>
                                    <td class="text-sm">${s.licencia}</td>
                                    <td class="mono text-xs">${s.equipoId}</td>
                                    <td class="text-sm">${s.juzgado}</td>
                                    <td><span class="badge ${s.status === 'Activo' ? 'badge-success' : 'badge-neutral'}">${s.status.toUpperCase()}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="text-xs text-muted" style="margin-top: 1rem;">
                    <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle;">info</span>
                    Los registros inactivos permanecen visibles para auditoría. Nada se elimina del sistema.
                </div>
            `;
        }

        function renderContracts() {
            return `
                <div class="flex justify-between items-center" style="margin-bottom: 1rem;">
                    <h3 class="font-bold text-lg">Contratos y SLA</h3>
                    ${currentUser.role === 'ADMIN' ? `<button class="badge badge-neutral" style="padding:0.5rem 1rem;">+ Nuevo Contrato</button>` : ''}
                </div>
                <div class="data-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Proveedor</th>
                                <th>Servicio</th>
                                <th>Cobertura</th>
                                <th>Inicio</th>
                                <th>Vencimiento</th>
                                <th>Alerta (días)</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${MOCK_DB.contracts.map(c => {
                let badgeClass = 'badge-success';
                if (c.status === 'Urgente') badgeClass = 'badge-urgent';
                if (c.status === 'Por Vencer') badgeClass = 'badge-warning';
                return `
                                <tr>
                                    <td class="mono font-bold text-xs">${c.id}</td>
                                    <td class="font-bold text-sm">${c.name}</td>
                                    <td class="text-sm">${c.provider}</td>
                                    <td class="text-sm">${c.service}</td>
                                    <td><span class="badge badge-neutral">${c.coverage}</span></td>
                                    <td class="mono text-xs">${c.start}</td>
                                    <td class="mono text-xs">${c.end}</td>
                                    <td class="mono text-xs" style="text-align:center;">${c.alertDays}</td>
                                    <td><span class="badge ${badgeClass}">${c.status.toUpperCase()}</span></td>
                                </tr>`;
            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="text-xs text-muted" style="margin-top: 1rem;">
                    <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle;">notifications_active</span>
                    Las alertas se disparan automáticamente cuando faltan los días configurados para el vencimiento.
                </div>
            `;
        }

        function renderLocations() {
            function getDepth(loc) {
                let depth = 0, current = loc;
                while (current.parent) {
                    depth++;
                    current = MOCK_DB.locations.find(l => l.id === current.parent) || { parent: null };
                }
                return depth;
            }
            function getChildren(parentId) {
                return MOCK_DB.locations.filter(l => l.parent === parentId);
            }
            function buildTree(parentId, depth) {
                return getChildren(parentId).map(l => `
                    <div style="margin-left: ${depth * 1.5}rem; padding: 0.6rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-card); display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.4rem; cursor: pointer; transition: all 0.15s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'" onclick="showLocationDetail('${l.id}')">
                        <span class="material-symbols-outlined" style="font-size: 1.2rem; color: ${l.type === 'Juzgado' ? 'var(--accent)' : 'var(--text-muted)'};">${l.icon}</span>
                        <div>
                            <div class="font-bold text-sm">${l.name}</div>
                            <div class="text-xs text-muted">${l.type}</div>
                        </div>
                    </div>
                    ${buildTree(l.id, depth + 1)}
                `).join('');
            }
            return `
                <div class="flex gap-4" style="height: calc(100vh - 180px);">
                    <div style="width: 380px; border-right: 1px solid var(--border); padding-right: 1rem; overflow-y: auto;">
                        <h3 class="font-bold text-sm uppercase text-muted" style="margin-bottom: 1rem;">Jerarquía Territorial</h3>
                        <div class="text-xs text-muted" style="margin-bottom: 0.75rem;">Circunscripción → Distrito → Ciudad → Edificio → Juzgado</div>
                        ${buildTree(null, 0)}
                    </div>
                    <div class="flex-1 p-4" id="location-detail" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; overflow-y: auto;">
                        <div class="flex items-center gap-2 text-muted" style="margin-top: 2rem;">
                            <span class="material-symbols-outlined" style="font-size: 4rem; opacity: 0.15;">domain</span>
                            <div>
                                <h2 style="font-size: 1.25rem; font-weight: bold;">Detalle de Estructura</h2>
                                <p>Seleccione un nodo del árbol para ver sus equipos y datos asociados.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAudit() {
            return `
                <div style="margin-bottom: 1rem;">
                    <p class="text-sm text-muted">Registro completo de cambios. Nada se elimina: los registros inactivos permanecen para auditoría.</p>
                </div>
                <div class="data-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha / Hora</th>
                                <th>Entidad</th>
                                <th>ID</th>
                                <th>Campo</th>
                                <th>Valor Anterior</th>
                                <th>Valor Nuevo</th>
                                <th>Autor</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${MOCK_DB.auditLog.map(a => `
                                <tr>
                                    <td class="mono text-xs">${a.fecha}</td>
                                    <td class="text-sm font-bold">${a.entidad}</td>
                                    <td class="mono text-xs">${a.entityId}</td>
                                    <td class="text-sm">${a.campo}</td>
                                    <td class="text-sm" style="color: var(--danger); text-decoration: line-through;">${a.valorAnterior}</td>
                                    <td class="text-sm font-bold" style="color: var(--success);">${a.valorNuevo}</td>
                                    <td class="text-sm">${a.autor}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPriorityBadge(p) {
            if (p === 'ALTA') return `<span class="badge badge-urgent">ALTA</span>`;
            if (p === 'MEDIA') return `<span class="badge badge-warning">MEDIA</span>`;
            return `<span class="badge badge-neutral">BAJA</span>`;
        }

        function renderStatusBadge(s) {
            if (s === 'Solicitado') return `<span class="badge" style="background: rgba(59, 130, 246, 0.1); color: var(--info); border: 1px solid rgba(59, 130, 246, 0.2);">SOLICITADO</span>`;
            if (s === 'Asignado') return `<span class="badge" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.2);">ASIGNADO</span>`;
            if (s === 'En Curso') return `<span class="badge badge-warning">EN CURSO</span>`;
            if (s === 'Cerrado') return `<span class="badge badge-success">CERRADO</span>`;
            return `<span class="badge badge-neutral">${s.toUpperCase()}</span>`;
        }

        // --- INTERACTION LOGIG ---

        function navTo(viewId) {
            currentView = viewId;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeItem = [...document.querySelectorAll('.nav-item')].find(el => el.onclick && el.onclick.toString().includes(viewId));
            if (activeItem) activeItem.classList.add('active');

            const contentEl = document.getElementById('content-area');
            const titleEl = document.getElementById('page-title');

            const views = {
                'dashboard': { title: 'Dashboard Ejecutivo', render: renderDashboard },
                'tickets': { title: 'Mesa de Ayuda (Casos)', render: renderTickets },
                'inventory': { title: 'Inventario de Hardware', render: renderInventory },
                'software': { title: 'Inventario de Software', render: renderSoftware },
                'contracts': { title: 'Contratos y SLA', render: renderContracts },
                'locations': { title: 'Organización Territorial', render: renderLocations },
                'audit': { title: 'Auditoría de Cambios', render: renderAudit },
                'users': { title: 'Usuarios y Roles', render: renderUsers },
            };
            const v = views[viewId];
            if (v) {
                titleEl.innerText = v.title;
                contentEl.innerHTML = v.render();
                logDev(`Navigated to ${v.title}`);
            } else {
                titleEl.innerText = viewId;
                contentEl.innerHTML = `<div class="p-4 text-muted">Vista: ${viewId}</div>`;
            }
        }

        function showBitacora(ticketId) {
            const ticket = MOCK_DB.tickets.find(t => t.id === ticketId);
            if (!ticket) return;
            const html = ticket.bitacora.map(b => `<div style="padding:0.75rem;border-bottom:1px solid var(--border);"><div class="flex justify-between"><span class="font-bold text-sm">${b.autor}</span><span class="mono text-xs text-muted">${b.fecha}</span></div><div class="text-sm" style="margin-top:0.25rem;">${b.nota}</div></div>`).join('');
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            overlay.innerHTML = `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;width:550px;max-height:80vh;overflow-y:auto;"><div style="padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;"><h3 class="font-bold">Bitácora — ${ticketId}</h3><button onclick="this.closest('div[style*=fixed]').remove()" style="background:none;border:none;cursor:pointer;font-size:1.25rem;">✕</button></div>${html}</div>`;
            document.body.appendChild(overlay);
        }

        let currentTicketDetailId = null;

        function abrirDetalleTicket(ticketId) {
            currentTicketDetailId = ticketId;
            const t = MOCK_DB.tickets.find(x => x.id === ticketId);
            if (!t) return;
            document.getElementById('det-titulo').innerHTML = `<span class="material-symbols-outlined" style="vertical-align:middle;margin-right:0.5rem;">confirmation_number</span>${t.id}`;
            // Restrict technician to only 'En Curso' and 'Cerrado'
            const estadoSel = document.getElementById('det-estado');
            if (currentUser.role === 'TECHNICIAN') {
                estadoSel.innerHTML = '<option>En Curso</option><option>Cerrado</option>';
            } else {
                estadoSel.innerHTML = '<option>Solicitado</option><option>Asignado</option><option>En Curso</option><option>Cerrado</option>';
            }
            estadoSel.value = t.status;
            document.getElementById('det-info').innerHTML = `
                <div><div class="text-xs uppercase text-muted font-bold" style="margin-bottom:0.2rem;">ASUNTO</div><div class="font-bold">${t.subject}</div></div>
                <div><div class="text-xs uppercase text-muted font-bold" style="margin-bottom:0.2rem;">JUZGADO</div><div>${t.juzgado}</div></div>
                <div><div class="text-xs uppercase text-muted font-bold" style="margin-bottom:0.2rem;">EQUIPO</div><div class="mono text-xs">${t.equipoId}</div></div>
                <div><div class="text-xs uppercase text-muted font-bold" style="margin-bottom:0.2rem;">TÉCNICO</div><div>${t.assignedTo}</div></div>
            `;
            // Show technician assignment dropdown for Admin/Operator only
            const tecWrap = document.getElementById('det-tecnico-wrap');
            if (currentUser.role === 'ADMIN' || currentUser.role === 'OPERATOR') {
                tecWrap.style.display = 'block';
                document.getElementById('det-tecnico').value = t.assignedTo === '--' ? '--' : t.assignedTo;
            } else {
                tecWrap.style.display = 'none';
            }
            document.getElementById('det-bitacora').innerHTML = t.bitacora.length ? `<div class="text-xs uppercase text-muted font-bold" style="margin-bottom:0.4rem;">BITÁCORA</div>${t.bitacora.map(b => `<div style="padding:0.5rem 0.75rem;background:var(--bg-body);border-radius:6px;font-size:0.85rem;margin-bottom:0.3rem;border:1px solid var(--border);"><strong>${b.autor}</strong> <span class="mono text-xs text-muted">${b.fecha}</span><br>${b.nota}</div>`).join('')}` : '';
            document.getElementById('det-nota').value = '';
            openFormModal('modal-detalle-ticket');
        }

        function actualizarTicket() {
            const t = MOCK_DB.tickets.find(x => x.id === currentTicketDetailId);
            if (!t) return;
            const oldStatus = t.status;
            const newStatus = document.getElementById('det-estado').value;
            const nota = document.getElementById('det-nota').value.trim();
            t.status = newStatus;
            // Handle technician assignment (Admin/Operator)
            const oldTecnico = t.assignedTo;
            if (currentUser.role === 'ADMIN' || currentUser.role === 'OPERATOR') {
                const newTecnico = document.getElementById('det-tecnico').value;
                if (newTecnico !== oldTecnico) {
                    t.assignedTo = newTecnico;
                    if (newTecnico !== '--' && t.status === 'Solicitado') { t.status = 'Asignado'; }
                    MOCK_DB.auditLog.unshift({ id: MOCK_DB.auditLog.length + 1, fecha: new Date().toISOString().replace('T', ' ').split('.')[0], entidad: 'Caso', entityId: t.id, campo: 'Técnico', valorAnterior: oldTecnico, valorNuevo: newTecnico, autor: currentUser.name });
                    logDev(`AUDIT: Ticket ${t.id} assigned from '${oldTecnico}' to '${newTecnico}'`);
                }
            }
            if (nota) {
                t.bitacora.push({ fecha: new Date().toISOString().replace('T', ' ').split('.')[0], autor: currentUser.name, nota });
            }
            MOCK_DB.auditLog.unshift({ id: MOCK_DB.auditLog.length + 1, fecha: new Date().toISOString().replace('T', ' ').split('.')[0], entidad: 'Caso', entityId: t.id, campo: 'Estado', valorAnterior: oldStatus, valorNuevo: t.status, autor: currentUser.name });
            closeFormModal('modal-detalle-ticket');
            navTo('tickets');
            renderSidebar();
            const msgs = [`Estado: ${oldStatus} → ${t.status}`];
            if (oldTecnico !== t.assignedTo) msgs.push(`Técnico: ${t.assignedTo}`);
            showToast(`Ticket ${t.id} actualizado — ${msgs.join(' | ')}`);
            logDev(`AUDIT: Ticket ${t.id} status changed from ${oldStatus} to ${t.status}`);
        }

        let ticketCounter = 7;

        function crearTicket() {
            const asunto = document.getElementById('nt-asunto').value.trim();
            if (!asunto) { showToast('⚠ Ingrese un asunto'); return; }
            const id = `CAS-2026-${String(ticketCounter).padStart(3, '0')}`;
            ticketCounter++;
            const juzgado = document.getElementById('nt-juzgado').value;
            const prioridad = document.getElementById('nt-prioridad').value;
            const equipo = document.getElementById('nt-equipo').value.trim() || '--';
            const tecnico = document.getElementById('nt-tecnico').value;
            const desc = document.getElementById('nt-desc').value.trim();
            MOCK_DB.tickets.unshift({
                id, subject: asunto, status: tecnico !== '--' ? 'Asignado' : 'Solicitado',
                priority: prioridad, juzgado, assignedTo: tecnico, equipoId: equipo,
                updated: 'ahora', bitacora: [{ fecha: new Date().toISOString().replace('T', ' ').split('.')[0], autor: currentUser.name, nota: 'Ticket creado. ' + (desc || '') }]
            });
            MOCK_DB.auditLog.unshift({ id: MOCK_DB.auditLog.length + 1, fecha: new Date().toISOString().replace('T', ' ').split('.')[0], entidad: 'Caso', entityId: id, campo: 'Creado', valorAnterior: '--', valorNuevo: prioridad, autor: currentUser.name });
            closeFormModal('modal-nuevo-ticket');
            ['nt-asunto', 'nt-equipo', 'nt-desc'].forEach(x => { const el = document.getElementById(x); if (el) el.value = ''; });
            navTo('tickets');
            renderSidebar();
            showToast(`✔ Ticket ${id} creado exitosamente`);
            logDev(`AUDIT: Ticket ${id} created — ${prioridad}`);
        }

        function registrarEquipo() {
            const marca = document.getElementById('ne-marca').value.trim();
            const modelo = document.getElementById('ne-modelo').value.trim();
            const inv = document.getElementById('ne-inv').value.trim();
            if (!marca || !modelo || !inv) { showToast('⚠ Complete los campos requeridos'); return; }
            MOCK_DB.hardware.unshift({
                id: inv, clase: document.getElementById('ne-clase').value,
                tipo: document.getElementById('ne-tipo').value,
                brand: marca, model: modelo,
                serial: document.getElementById('ne-serie').value || 'N/A',
                juzgado: document.getElementById('ne-juzgado').value,
                puesto: document.getElementById('ne-puesto').value || '—',
                status: 'Operativo', contract: '--'
            });
            MOCK_DB.auditLog.unshift({ id: MOCK_DB.auditLog.length + 1, fecha: new Date().toISOString().replace('T', ' ').split('.')[0], entidad: 'Activo', entityId: inv, campo: 'Creado', valorAnterior: '--', valorNuevo: `${marca} ${modelo}`, autor: currentUser.name });
            closeFormModal('modal-nuevo-equipo');
            ['ne-marca', 'ne-modelo', 'ne-serie', 'ne-inv', 'ne-puesto'].forEach(x => { const el = document.getElementById(x); if (el) el.value = ''; });
            navTo('inventory');
            showToast(`✔ Equipo ${inv} registrado`);
            logDev(`AUDIT: Equipment ${inv} (${marca} ${modelo}) registered`);
        }

        function renderUsers() {
            const users = MOCK_DB.users;
            return `
                <div class="flex justify-between items-center" style="margin-bottom:1rem;">
                    <div class="text-sm text-muted">${users.length} usuarios registrados</div>
                    ${currentUser.role === 'ADMIN' ? `
                    <button class="badge" onclick="abrirModalUsuario()" style="padding:0.6rem 1rem;color:#fff;background:var(--accent);display:flex;align-items:center;gap:0.5rem;border:none;cursor:pointer;border-radius:8px;">
                        <span class="material-symbols-outlined" style="font-size:1.1rem;">person_add</span>
                        Nuevo Usuario
                    </button>` : ''}
                </div>
                <div class="data-table-container">
                    <table>
                        <thead><tr>
                            <th>Usuario</th><th>Nombre</th><th>Rol</th><th>Dependencia</th><th>Último Acceso</th><th>Estado</th>
                            ${currentUser.role === 'ADMIN' ? '<th>Acciones</th>' : ''}
                        </tr></thead>
                        <tbody>
                            ${users.map((u, i) => `
                            <tr style="${!u.activo ? 'opacity:0.6;' : ''}">
                                <td class="mono font-bold text-xs">${u.user}</td>
                                <td>${u.nombre}</td>
                                <td class="text-sm">${u.rol}</td>
                                <td class="text-sm">${u.dep}</td>
                                <td class="mono text-xs">${u.ultimo}</td>
                                <td><span class="badge ${u.activo ? 'badge-success' : 'badge-neutral'}">${u.activo ? 'ACTIVO' : 'INACTIVO'}</span></td>
                                ${currentUser.role === 'ADMIN' ? `<td>
                                    <button onclick="editarUsuario(${i})" style="background:none;border:none;cursor:pointer;color:var(--info);" title="Editar"><span class="material-symbols-outlined" style="font-size:1.1rem;">edit</span></button>
                                    <button onclick="eliminarUsuario(${i})" style="background:none;border:none;cursor:pointer;color:var(--danger);" title="Eliminar"><span class="material-symbols-outlined" style="font-size:1.1rem;">delete</span></button>
                                </td>` : ''}
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function openFormModal(id) { document.getElementById(id).classList.add('open'); }
        function closeFormModal(id) { document.getElementById(id).classList.remove('open'); }

        let editingUserIdx = null;

        function abrirModalUsuario(idx) {
            editingUserIdx = (idx !== undefined) ? idx : null;
            const m = document.getElementById('modal-usuario');
            document.getElementById('mu-titulo').textContent = editingUserIdx !== null ? 'Editar Usuario' : 'Nuevo Usuario';
            if (editingUserIdx !== null) {
                const u = MOCK_DB.users[editingUserIdx];
                document.getElementById('mu-user').value = u.user;
                document.getElementById('mu-user').disabled = true;
                document.getElementById('mu-nombre').value = u.nombre;
                document.getElementById('mu-rol').value = u.rol;
                document.getElementById('mu-dep').value = u.dep;
                document.getElementById('mu-activo').value = u.activo ? 'true' : 'false';
            } else {
                document.getElementById('mu-user').value = '';
                document.getElementById('mu-user').disabled = false;
                document.getElementById('mu-nombre').value = '';
                document.getElementById('mu-rol').value = 'Técnico de Soporte';
                document.getElementById('mu-dep').value = '';
                document.getElementById('mu-activo').value = 'true';
            }
            openFormModal('modal-usuario');
        }

        function editarUsuario(idx) { abrirModalUsuario(idx); }

        function guardarUsuario() {
            const user = document.getElementById('mu-user').value.trim();
            const nombre = document.getElementById('mu-nombre').value.trim();
            const rol = document.getElementById('mu-rol').value;
            const dep = document.getElementById('mu-dep').value.trim();
            const activo = document.getElementById('mu-activo').value === 'true';
            if (!user || !nombre) { showToast('⚠ Complete usuario y nombre'); return; }
            const now = new Date().toISOString().replace('T', ' ').split('.')[0];
            if (editingUserIdx !== null) {
                const u = MOCK_DB.users[editingUserIdx];
                u.nombre = nombre; u.rol = rol; u.dep = dep; u.activo = activo;
                MOCK_DB.auditLog.unshift({ id: MOCK_DB.auditLog.length + 1, fecha: now, entidad: 'Usuario', entityId: user, campo: 'Editado', valorAnterior: '--', valorNuevo: rol, autor: currentUser.name });
                showToast(`✔ Usuario ${user} actualizado`);
                logDev(`AUDIT: User ${user} updated`);
            } else {
                if (MOCK_DB.users.some(u => u.user === user)) { showToast('⚠ El usuario ya existe'); return; }
                MOCK_DB.users.push({ user, nombre, rol, dep, ultimo: now, activo });
                MOCK_DB.auditLog.unshift({ id: MOCK_DB.auditLog.length + 1, fecha: now, entidad: 'Usuario', entityId: user, campo: 'Creado', valorAnterior: '--', valorNuevo: rol, autor: currentUser.name });
                showToast(`✔ Usuario ${user} creado`);
                logDev(`AUDIT: User ${user} created`);
            }
            closeFormModal('modal-usuario');
            navTo('users');
        }

        function eliminarUsuario(idx) {
            const u = MOCK_DB.users[idx];
            if (!confirm(`¿Eliminar usuario "${u.user}" (${u.nombre})?`)) return;
            MOCK_DB.users.splice(idx, 1);
            MOCK_DB.auditLog.unshift({ id: MOCK_DB.auditLog.length + 1, fecha: new Date().toISOString().replace('T', ' ').split('.')[0], entidad: 'Usuario', entityId: u.user, campo: 'Eliminado', valorAnterior: u.nombre, valorNuevo: '--', autor: currentUser.name });
            showToast(`Usuario ${u.user} eliminado`);
            logDev(`AUDIT: User ${u.user} deleted`);
            navTo('users');
        }

        function showLocationDetail(locId) {
            const loc = MOCK_DB.locations.find(l => l.id === locId);
            if (!loc) return;
            const hwHere = MOCK_DB.hardware.filter(h => h.juzgado.includes(loc.name.replace('Juz. ', '').substring(0, 10)) || loc.name.includes(h.juzgado));
            const children = MOCK_DB.locations.filter(l => l.parent === locId);
            const detail = document.getElementById('location-detail');
            if (!detail) return;
            detail.innerHTML = `
                <h2 class="font-bold" style="font-size:1.25rem;margin-bottom:0.25rem;"><span class="material-symbols-outlined" style="vertical-align:middle;margin-right:0.5rem;">${loc.icon}</span>${loc.name}</h2>
                <span class="badge badge-neutral" style="margin-bottom:1rem;display:inline-block;">${loc.type}</span>
                ${children.length ? `<div style="margin-bottom:1rem;"><h4 class="font-bold text-sm text-muted" style="margin-bottom:0.5rem;">Sub-unidades (${children.length})</h4>${children.map(c => `<span class="badge badge-neutral" style="margin:0.15rem;">${c.name}</span>`).join('')}</div>` : ''}
                ${hwHere.length ? `<div><h4 class="font-bold text-sm text-muted" style="margin-bottom:0.5rem;">Equipos Asociados (${hwHere.length})</h4><table style="width:100%;"><thead><tr><th class="text-xs">ID</th><th class="text-xs">Clase</th><th class="text-xs">Modelo</th><th class="text-xs">Estado</th></tr></thead><tbody>${hwHere.map(h => `<tr><td class="mono text-xs">${h.id}</td><td class="text-sm">${h.clase}</td><td class="text-sm">${h.brand} ${h.model}</td><td><span class="badge ${h.status === 'Operativo' ? 'badge-success' : 'badge-warning'}">${h.status}</span></td></tr>`).join('')}</tbody></table></div>` : `<p class="text-sm text-muted" style="margin-top:1rem;">No hay equipos directamente asignados a este nivel.</p>`}
            `;
        }


        // --- RBAC LOGIC ---
        function setRole(role) {
            currentUser.role = role;
            currentUser.name = role === 'ADMIN' ? 'Juan Martinez' : (role === 'OPERATOR' ? 'Marta Operadora' : 'Tecnico Luis');
            document.getElementById('user-display-name').innerText = `${currentUser.name} (${ROLES[role].label})`;
            renderSidebar();
            navTo('dashboard');
            logDev(`Role switched to: ${role}`);
            showToast(`Perfil cambiado a: ${ROLES[role].label}`);
        }

        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            let html = '';

            // TECHNICIAN: only sees their assigned tickets
            if (currentUser.role === 'TECHNICIAN') {
                html += `
                <div class="nav-item active" onclick="navTo('tickets')">
                    <span class="material-symbols-outlined">assignment_ind</span>
                    Mis Casos Asignados
                </div>`;
                nav.innerHTML = html;
                return;
            }

            // Dashboard (Admin/Operator)
            html += `
             <div class="nav-item ${currentView === 'dashboard' ? 'active' : ''}" onclick="navTo('dashboard')">
                <span class="material-symbols-outlined">dashboard</span>
                Dashboard
            </div>`;

            // Tickets (Admin/Operator)
            const openCount = MOCK_DB.tickets.filter(t => t.status !== 'Cerrado').length;
            html += `
                <div class="nav-item ${currentView === 'tickets' ? 'active' : ''}" onclick="navTo('tickets')">
                    <span class="material-symbols-outlined">confirmation_number</span>
                    Mesa de Ayuda
                    ${openCount ? `<span class="nav-badge">${openCount}</span>` : ''}
                </div>`;

            // Inv. Hardware (Admin/Operator)
            html += `
                <div class="nav-item ${currentView === 'inventory' ? 'active' : ''}" onclick="navTo('inventory')">
                    <span class="material-symbols-outlined">devices</span>
                    Inv. Hardware
                </div>`;

            // Inv. Software (Admin/Operator)
            html += `
                <div class="nav-item ${currentView === 'software' ? 'active' : ''}" onclick="navTo('software')">
                    <span class="material-symbols-outlined">apps</span>
                    Inv. Software
                </div>`;

            // Contracts (Admin/Operator)
            const urgentContracts = MOCK_DB.contracts.filter(c => c.status === 'Urgente' || c.status === 'Por Vencer').length;
            html += `
                <div class="nav-item ${currentView === 'contracts' ? 'active' : ''}" onclick="navTo('contracts')">
                    <span class="material-symbols-outlined">verified_user</span>
                    Contratos
                    ${urgentContracts ? `<span class="nav-badge" style="background:var(--warning);">${urgentContracts}</span>` : ''}
                </div>`;

            // Locations (Admin/Operator)
            html += `
                <div class="nav-item ${currentView === 'locations' ? 'active' : ''}" onclick="navTo('locations')">
                    <span class="material-symbols-outlined">location_city</span>
                    Estructura
                </div>`;

            // Audit (Admin only)
            if (currentUser.role === 'ADMIN') {
                html += `
                <div class="nav-item ${currentView === 'audit' ? 'active' : ''}" onclick="navTo('audit')">
                    <span class="material-symbols-outlined">history_edu</span>
                    Auditoría
                </div>`;
                html += `
                <div class="nav-item ${currentView === 'users' ? 'active' : ''}" onclick="navTo('users')">
                    <span class="material-symbols-outlined">group</span>
                    Usuarios
                </div>`;
            }

            nav.innerHTML = html;
        }

        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', next);
            logDev(`Theme toggled to ${next}`);
        }

        function toggleDevPanel() {
            document.getElementById('dev-panel').classList.toggle('open');
        }

        function logDev(msg) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<div class="log-time">${new Date().toISOString().split('T')[1].split('.')[0]}</div><div>${msg}</div>`;
            document.getElementById('dev-logs').prepend(entry);
        }

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span class="material-symbols-outlined">check_circle</span> <span>${msg}</span>`;
            container.appendChild(toast);

            // Log to Audit
            logDev(`AUDIT: Action Confirmed - ${msg}`);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function auditAction(action, targetId) {
            // Simulate an action that generates an audit log
            const locations = ['Anexo Penal', 'Juzgado Paz Letrado', 'Depósito Central'];
            const newLoc = locations[Math.floor(Math.random() * locations.length)];

            showToast(`Activo ${targetId} movido a ${newLoc}`);
            logDev(`AUDIT [WRITE]: Entity=Asset ID=${targetId} Field=Location Old=Civil N°1 New=${newLoc} User=jmartinez`);
        }

        // --- ASSISTANT LOGIC ---
        function openAssistant() {
            document.getElementById('ai-modal').classList.add('open');
            document.getElementById('chat-input').focus();
        }

        function closeAssistant() {
            document.getElementById('ai-modal').classList.remove('open');
            // Cleanup chat
            setTimeout(() => {
                const body = document.getElementById('chat-messages');
                body.innerHTML = '<div class="message msg-ai">Hola, soy tu asistente virtual. Descríbeme el problema y te ayudaré a crear el ticket automáticamente.</div>';
            }, 300);
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') sendChatMessage();
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            // Add User Message
            const body = document.getElementById('chat-messages');
            body.innerHTML += `<div class="message msg-user">${text}</div>`;
            input.value = '';
            body.scrollTop = body.scrollHeight;

            // Simulate AI Response
            setTimeout(() => {
                let response = "Entendido. He analizado tu solicitud.";
                if (text.toLowerCase().includes('impresora')) {
                    response = "Parece un problema de impresión. ¿Podrías indicarme el modelo o si muestra algún error en pantalla?";
                } else if (text.toLowerCase().includes('internet') || text.toLowerCase().includes('red')) {
                    response = "Detecto un posible problema de conectividad. He generado el Ticket #CAS-2026-099 con Prioridad MEDIA y lo he asignado al equipo de Redes.";
                    showToast("Ticket #CAS-2026-099 Creado");
                } else if (text.toLowerCase().includes('urgente') || text.toLowerCase().includes('fuego') || text.toLowerCase().includes('crítico')) {
                    response = "⚠️ He detectado una situación <strong>CRÍTICA</strong>. He escalado el Ticket #CAS-2026-099 con Prioridad <strong>ALTA</strong> y notificado al Supervisor de turno.";
                    showToast("🚨 Ticket CRÍTICO Creado y Escalado");
                } else {
                    response = "He registrado el incidente. Se ha creado el Ticket #CAS-2026-100 y un técnico se pondrá en contacto a la brevedad.";
                    showToast("Ticket #CAS-2026-100 Creado");
                }

                body.innerHTML += `<div class="message msg-ai">${response}</div>`;
                body.scrollTop = body.scrollHeight;
            }, 1000);
        }

        // --- LOGIN / LOGOUT LOGIC ---
        const MOCK_CREDENTIALS = {
            ADMIN: { user: 'admin', pass: 'admin123', name: 'Juan Martinez' },
            OPERATOR: { user: 'operador', pass: 'oper123', name: 'Marta Operadora' },
            TECHNICIAN: { user: 'tecnico', pass: 'tec123', name: 'L. Gomez' }
        };

        let selectedLoginRole = null;

        function selectLoginRole(role) {
            selectedLoginRole = role;
            // Highlight selected card
            document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`.role-card[data-role="${role}"]`).classList.add('selected');

            // Show form
            const form = document.getElementById('login-form');
            form.classList.add('visible');
            document.getElementById('login-user').value = '';
            document.getElementById('login-pass').value = '';
            document.getElementById('login-error').textContent = '';
            document.getElementById('login-user').focus();

            // Show hint
            const creds = MOCK_CREDENTIALS[role];
            document.getElementById('login-hint').innerHTML =
                `Demo &rarr; usuario: <code>${creds.user}</code> &nbsp;|&nbsp; clave: <code>${creds.pass}</code>`;
        }

        function handleLogin() {
            if (!selectedLoginRole) return;

            const user = document.getElementById('login-user').value.trim();
            const pass = document.getElementById('login-pass').value;
            const creds = MOCK_CREDENTIALS[selectedLoginRole];

            if (user === creds.user && pass === creds.pass) {
                // Success — enter the app
                document.getElementById('login-error').textContent = '';
                document.getElementById('login-screen').classList.add('hidden-login');

                // Set the role + user
                currentUser.role = selectedLoginRole;
                currentUser.name = creds.name;
                currentUser.id = creds.user;

                document.getElementById('user-display-name').innerText =
                    `${creds.name} (${ROLES[selectedLoginRole].label})`;
                document.getElementById('role-indicator').innerText = ROLES[selectedLoginRole].label;

                renderSidebar();
                navTo(selectedLoginRole === 'TECHNICIAN' ? 'tickets' : 'dashboard');
                logDev(`Login OK — Role: ${selectedLoginRole}, User: ${creds.user}`);
                showToast(`Bienvenido, ${creds.name}`);
            } else {
                // Error
                document.getElementById('login-error').textContent =
                    '⚠ Usuario o contraseña incorrectos';
                document.getElementById('login-pass').value = '';
                document.getElementById('login-pass').focus();
            }
        }

        function logout() {
            // Reset state
            selectedLoginRole = null;
            currentUser.role = 'ADMIN';
            currentUser.name = '';
            currentUser.id = '';

            // Reset login form
            document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('login-form').classList.remove('visible');
            document.getElementById('login-user').value = '';
            document.getElementById('login-pass').value = '';
            document.getElementById('login-error').textContent = '';

            // Show login screen
            document.getElementById('login-screen').classList.remove('hidden-login');
            logDev('User logged out.');
        }

        // Init — show login screen on load (sidebar hidden behind overlay)
        renderSidebar();
        logDev('System Initialized. Login screen active.');

    </script>
</body>

</html>